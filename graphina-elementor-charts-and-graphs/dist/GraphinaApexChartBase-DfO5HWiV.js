class p{constructor(){this.chartHandlers={},this.init(),this.mainChart={}}init(){this.setUpChartsHandler(),this.bindEventHandlers(),this.bindElementorInit()}bindEventHandlers(){jQuery(document.body).on("change",".graphina-select-apex-chart-type",this.debounce(this.handleChartTypeChange.bind(this),300)),jQuery(document.body).off("click",".graphina-filter-div-button.apex"),jQuery(document.body).on("click",".graphina-filter-div-button.apex",this.debounce(this.handleChartFilter.bind(this),300))}bindElementorInit(){let a=!1;const e=()=>{a||(a=!0,elementorFrontend.hooks.addAction("frontend/element_ready/global",t=>{const r=t.find(".graphina-elementor-chart");r.length>0&&this.initializeCharts(r)}))};typeof elementorFrontend<"u"&&elementorFrontend.hooks&&e(),jQuery(window).on("elementor/frontend/init",e),jQuery(document).ready(()=>{!a&&typeof elementorFrontend<"u"&&elementorFrontend.hooks&&e()})}debounce(a,e){let t;return function(...r){const i=this;clearTimeout(t),t=setTimeout(()=>a.apply(i,r),e)}}observeChartElement(a,e){const t=a.data("element_id");gcfe_public_localize.view_port==="off"?(this.observer[t]||(this.observer[t]=new IntersectionObserver(r=>{r.forEach(i=>{i.isIntersecting&&(this.setupChart(jQuery(i.target),e),this.observer[t].unobserve(i.target),this.observer[t].disconnect(),delete this.observer[t])})},{threshold:.1})),this.observer[t].observe(a[0])):this.setupChart(a,e)}handleChartTypeChange(a){const e=jQuery(a.target),t=e.val(),r=e.data("element_id"),i=jQuery(`.graphina-elementor-chart[data-element_id="${r}"]`);i.length>0&&(ApexCharts.exec(r,"destroy"),this.updateChartType(i,t))}handleChartFilter(a){const e=a.currentTarget,t=jQuery(e).data("element_id"),r=jQuery(`.graphina-elementor-chart[data-element_id="${t}"]`);let i=jQuery(r).data("chart_type");r.length>0&&(ApexCharts.exec(t,"destroy"),console.log(jQuery(document).find(`.graphina-${t}-loader`)),jQuery(document).find(`.graphina-${t}-loader`).show(),this.updateChartType(r,i,!0))}setUpChartsHandler(){throw new Error("setUpChartsHandler method must be implemented by subclasses")}initializeCharts(a){const e=a.data("chart_type");this.chartHandlers[e]&&this.chartHandlers[e](a)}formatNumber(a,e){const t=["","K","M","B","T"];let r=0;for(;a>=1e3&&r<t.length-1;)a/=1e3,r++;return new Intl.NumberFormat(window.gcfe_public_localize.locale_with_hyphen,{minimumFractionDigits:e,maximumFractionDigits:e}).format(a)+t[r]}applyLegendTooltip(a,e,t){e.legend_show_series_value&&(a.legend.tooltipHoverFormatter=(r,i)=>{let n=i.w.globals.series[i.seriesIndex][i.dataPointIndex];return r=decodeURIComponent(r),["polar","column","line","scatter","pie","donut","radial"].includes(t)&&(n=i.w.globals.series[i.seriesIndex]),`<div class="legend-info"><span>${r}</span>:<strong>${n}</strong></div>`})}applyXAxisFormatter(a,e){e.xaxis_label_prefix_show&&(a.xaxis.labels.formatter=t=>`${e.xaxis_label_prefix}${t}${e.xaxis_label_postfix}`)}applyYAxisFormatter(a,e,t=!1){const r=(n,c,s,l,d)=>e.chart_yaxis_label_pointer?c+this.formatNumber(n,l)+s:e.yaxis_label_format&&(d===0||d===!1)?c+new Intl.NumberFormat(window.gcfe_public_localize.locale_with_hyphen,{minimumFractionDigits:l,maximumFractionDigits:l}).format(n)+s:e.chart_opposite_yaxis_format_number&&d===1?c+new Intl.NumberFormat(window.gcfe_public_localize.locale_with_hyphen,{minimumFractionDigits:l,maximumFractionDigits:l}).format(n)+s:c+n+s,i=(n,c,s,l,d)=>{n.labels||(n.labels={}),n.labels.formatter=o=>r(o,c,s,l,d)};if(t===!1)i(a.yaxis,e.yaxis_label_prefix,e.yaxis_label_postfix,e.decimal_in_float,t);else if(t===0||t===1){let n=a.yaxis[t],c=t===0?e.yaxis_label_prefix:e.chart_opposite_yaxis_label_prefix,s=t===0?e.yaxis_label_postfix:e.chart_opposite_yaxis_label_postfix,l=e.decimal_in_float;i(n,c,s,l,t)}}applyDataLabelFormatter(a,e){let t=e.chart_datalabel_prefix??"",r=e.chart_datalabel_postfix??"";a.dataLabels||(a.dataLabels={}),a.dataLabels.formatter=function(i){return e.chart_number_format_commas&&(i=new Intl.NumberFormat(window.gcfe_public_localize.locale_with_hyphen,{minimumFractionDigits:e.chart_datalabel_decimals_in_float,maximumFractionDigits:e.chart_datalabel_decimals_in_float}).format(i)),t+i+r}}async updateChartType(a,e,t=!1){const r=a.data("element_id"),i=a.data("chart_options"),n=a.data("extra_data"),c=a.data("settings");if(!i||!r||!e){console.error("Missing required chart options or element ID.");return}if(e==="bar"&&i.chart.type!=="bar"&&(i.tooltip.shared=!1),i.chart.type=e,t){let l=[];const d=jQuery(`#graphina_chart_filter_${r}`).data("total_filter");for(let _=0;_<d;_++)l[_]=jQuery(`#graphina-start-date_${_}${r}`).val()??jQuery(`#graphina-drop_down_filter_${_}${r}`).val();const o=await this.getDynamicData(c,n,e,r,l);o.extra!==void 0?(i.series=o.extra.series,i.xaxis.categories=o.extra.category):(i.series=[],i.xaxis.categories=[])}e==="column"&&(i.chart.type="bar"),new ApexCharts(a[0],i).render().then(()=>console.log(`Chart updated to ${e}.`)).catch(l=>console.error("Error updating chart:",l)),jQuery(document).find(`.graphina-${r}-loader`).hide()}setFieldForForminator(a,e,t){const r=t.section_chart_forminator_aggregate,n=["mixed","brush","gantt_google"].includes(e)?a.forminator_columns:a.extra.forminator_columns;r?this.populateDropdownField(`[data-setting="${t.graphina_prefix}${e}_section_chart_forminator_aggregate_column"]`,n,t.section_chart_forminator_aggregate_column):(this.populateDropdownField(`[data-setting="${t.graphina_prefix}${e}_section_chart_forminator_x_axis_columns"]`,n,t.section_chart_forminator_x_axis_columns),this.populateDropdownField(`[data-setting="${t.graphina_prefix}${e}_section_chart_forminator_y_axis_columns"]`,n,t.section_chart_forminator_y_axis_columns))}setFieldsForCSV(a,e,t,r){const i=r.chart_dynamic_data_option==="sql-builder",n=i?e.extra.db_column:e.extra.column;this.populateDropdownField(`[data-setting="${r.graphina_prefix}${t}_${i?"chart_sql_builder_x_columns":"chart_csv_x_columns"}"]`,n,i?r.chart_csv_x_columns_sql:r.chart_csv_x_columns),this.populateDropdownField(`[data-setting="${r.graphina_prefix}${t}_${i?"chart_sql_builder_y_columns":"chart_csv_y_columns"}"]`,n,i?r.chart_csv_y_columns_sql:r.chart_csv_y_columns)}populateDropdownField(a,e,t){const r=parent.document.querySelector(a);if(r){r.innerHTML="";try{e.forEach(i=>{const n=Array.isArray(t)?t.includes(i):t===i;r.append(new Option(i,i,n,n))})}catch(i){console.log(i)}}}setFieldsForCounter(a,e,t,r){return!0}getDynamicData(a,e,t,r,i){let n="graphina_get_dynamic_data",c=gcfe_public_localize.nonce;t==="counter"&&(n="get_jquery_datatable_data",c=gcfe_public_localize.table_nonce);let s=jQuery(`[data-element_id="${r}"]`).closest("[data-elementor-id]").data("elementor-id");return new Promise((l,d)=>{jQuery.ajax({url:gcfe_public_localize.ajaxurl,type:"POST",dataType:"json",data:{action:n,nonce:c,chartType:t,post_id:s,element_id:r,series_count:e.chart_data_series_count_dynamic,settings:JSON.stringify(a),selected_field:i},success:o=>{o.status&&jQuery("body").hasClass("elementor-editor-active")&&(t==="counter"&&this.setFieldsForCounter(a,o,t,e),(e.chart_csv_column_wise_enable||e.chart_dynamic_data_option==="sql-builder")&&(e.chart_dynamic_data_option==="csv"||e.chart_dynamic_data_option==="remote-csv"||e.chart_dynamic_data_option==="google-sheet"||e.chart_dynamic_data_option==="sql-builder")&&this.setFieldsForCSV(a,o,t,e),e.dynamic_type==="forminator"&&this.setFieldForForminator(o,t,e)),l(o)},error:o=>{console.error("AJAX Error:",o),d(new Error("AJAX request failed."))}})})}getChartOptions(a,e,t,r,i){return a}afterRenderChart(a,e,t){return a}processDynamicData(a,e,t){return!0}afterManualLoad(a,e,t){return!0}afterDynamicLoad(a,e,t){return!0}async setupChart(a,e){try{const t=a.data("element_id"),r=a.data("chart_options"),i=a.data("responsive_options"),n=a.data("extra_data"),c=a.data("settings"),s=a.data("chart_type");if((s==="nested_column"||s==="brush"||s==="column")&&(e=s),!r||!t){console.error(`Missing required data attributes for ${e} chart.`);return}if(n.chart_data_option===!0){try{let o=[];const _=jQuery(`#graphina_chart_filter_${t}`).data("total_filter");for(let u=0;u<_;u++)o[u]=jQuery(`#graphina-start-date_${u}${t}`).val()??jQuery(`#graphina-drop_down_filter_${u}${t}`).val();const h=await this.getDynamicData(c,n,e,t,o);this.processDynamicData(h,t,n),h.extra!==void 0?s==="nested_column"?r.series=[{data:h.extra.series}]:(r.series=h.extra.series,r.xaxis.categories=h.extra.category):(r.series=[],r.xaxis.categories=[]),this.afterDynamicLoad(h,t,n)}catch(o){console.error("Failed to get dynamic data:",o)}jQuery(document).find(`.graphina-${t}-loader`).hide()}else this.afterManualLoad([],t,n);this.applyLegendTooltip(r,n,s),this.applyXAxisFormatter(r,n),this.applyDataLabelFormatter(r,n),n.chart_opposite_yaxis_title_enable?(this.applyYAxisFormatter(r,n,0),this.applyYAxisFormatter(r,n,1)):this.applyYAxisFormatter(r,n,!1);const l=this.getChartOptions(r,e,n,i,t);this.mainChart[t]&&this.mainChart[t].destroy();const d=new ApexCharts(jQuery(a)[0],l);try{await d.render()}catch(o){console.warn(o)}this.mainChart[t]=d,this.afterRenderChart(d,t,n),n.can_chart_reload_ajax&&setInterval(async()=>{try{const o=await this.getDynamicData(c,n,e,t);o!=null&&o.extra?(d.updateSeries(o.extra.series),d.updateOptions(o.chart_option)):console.warn(`No data returned for ${e} chart with ID ${t}.`)}catch{console.warn(`Error fetching dynamic data for ${e} chart with ID ${t}:`)}},n.interval_data_refresh*1e3)}catch(t){console.error(`Error initializing ${e} chart:`,t)}}}export{p as G};
//# sourceMappingURL=GraphinaApexChartBase-DfO5HWiV.js.map
