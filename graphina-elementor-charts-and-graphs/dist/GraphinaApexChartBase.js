class p{constructor(){this.chartHandlers={},this.init(),this.mainChart={},this.chartIntervals={}}init(){this.setUpChartsHandler(),this.bindEventHandlers(),this.bindElementorInit()}bindEventHandlers(){jQuery(document.body).on("change",".graphina-select-apex-chart-type",this.debounce(this.handleChartTypeChange.bind(this),300)),jQuery(document.body).off("click",".graphina-filter-div-button.apex"),jQuery(document.body).on("click",".graphina-filter-div-button.apex",this.debounce(this.handleChartFilter.bind(this),300)),jQuery(document.body).off("click",".graphina-filter-div-button.common")}bindElementorInit(){let r=!1;const e=()=>{r||window.elementorFrontend&&window.elementorFrontend.elementsHandler&&(r=!0,window.elementorFrontend.hooks.addAction("frontend/element_ready/widget",t=>{const i=t.find(".graphina-elementor-chart");i.length>0&&this.initializeCharts(i)}))};window.elementorFrontend&&window.elementorFrontend.elementsHandler&&e(),jQuery(window).on("elementor/frontend/init",()=>{setTimeout(e,50)}),jQuery(document).ready(()=>{if(!r){const t=jQuery(".graphina-elementor-chart");t.length>0&&t.each((i,a)=>{this.initializeCharts(jQuery(a))})}})}debounce(r,e){let t;return function(...i){const a=this;clearTimeout(t),t=setTimeout(()=>r.apply(a,i),e)}}observeChartElement(r,e){const t=r.data("element_id");gcfe_public_localize.view_port==="off"?(this.observer[t]||(this.observer[t]=new IntersectionObserver(i=>{i.forEach(a=>{a.isIntersecting&&(this.setupChart(jQuery(a.target),e),this.observer[t].unobserve(a.target),this.observer[t].disconnect(),delete this.observer[t])})},{threshold:.1})),this.observer[t].observe(r[0])):this.setupChart(r,e)}handleChartTypeChange(r){const e=jQuery(r.target),t=e.val(),i=e.data("element_id"),a=jQuery(`.graphina-elementor-chart[data-element_id="${i}"]`);a.length>0&&(ApexCharts.exec(i,"destroy"),this.updateChartType(a,t))}handleChartFilter(r){const e=r.currentTarget,t=jQuery(e).data("element_id"),i=jQuery(`.graphina-elementor-chart[data-element_id="${t}"]`);let a=jQuery(i).data("chart_type");i.length>0&&(jQuery(`.graphina-${t}-notext`).hide(),ApexCharts.exec(t,"destroy"),jQuery(document).find(`.graphina-${t}-loader`).show(),this.updateChartType(i,a,!0))}setUpChartsHandler(){throw new Error("setUpChartsHandler method must be implemented by subclasses")}initializeCharts(r){const e=r.data("chart_type");this.chartHandlers[e]&&this.chartHandlers[e](r)}formatNumber(r,e){const t=["","K","M","B","T"];let i=0;for(;r>=1e3&&i<t.length-1;)r/=1e3,i++;return new Intl.NumberFormat(window.gcfe_public_localize.locale_with_hyphen,{minimumFractionDigits:e,maximumFractionDigits:e}).format(r)+t[i]}applyLegendTooltip(r,e,t){e.legend_show_series_value&&(r.legend.tooltipHoverFormatter=(i,a)=>{let n=a.w.globals.series[a.seriesIndex][a.dataPointIndex];return i=decodeURIComponent(i),["polar","scatter","pie","donut","radial"].includes(t)&&(n=a.w.globals.series[a.seriesIndex]),`<div class="legend-info"><span>${i}</span>:<strong>${n}</strong></div>`})}applyXAxisFormatter(r,e){e.xaxis_label_prefix_show&&(r.xaxis.labels.formatter=t=>`${e.xaxis_label_prefix}${t}${e.xaxis_label_postfix}`)}applyYAxisFormatter(r,e,t=!1,i){const a=(c,o,d,l)=>e.chart_yaxis_label_pointer?o+this.formatNumber(c,l)+d:typeof l=="number"&&l>=0?o+new Intl.NumberFormat(window.gcfe_public_localize.locale_with_hyphen,{minimumFractionDigits:l,maximumFractionDigits:l}).format(c)+d:o+c+d,n=(c,o,d,l)=>{c.labels||(c.labels={}),c.labels.formatter=s=>a(s,o,d,l)};if(t===!1){const c=e.yaxis_label_prefix||"",o=e.yaxis_label_postfix||"";let d=0;e.chart_yaxis_label_pointer?d=typeof e.chart_yaxis_label_pointer_number=="number"?e.chart_yaxis_label_pointer_number:0:d=typeof e.decimal_in_float=="number"?e.decimal_in_float:0,n(r.yaxis,c,o,d)}else if(t===0||t===1){const c=r.yaxis[t],o=t===0?e.yaxis_label_prefix||"":e.chart_opposite_yaxis_label_prefix||"",d=t===0?e.yaxis_label_postfix||"":e.chart_opposite_yaxis_label_postfix||"";let l=0;(t===0||t===1&&e.chart_opposite_yaxis_format_number===!0)&&(e.chart_yaxis_label_pointer?l=typeof e.chart_yaxis_label_pointer_number=="number"?e.chart_yaxis_label_pointer_number:0:l=typeof e.decimal_in_float=="number"?e.decimal_in_float:0),n(c,o,d,l)}}applyDataLabelFormatter(r,e,t){let i=e.chart_datalabel_prefix??"",a=e.chart_datalabel_postfix??"";r.dataLabels||(r.dataLabels={}),r.dataLabels.formatter=n=>{if(e.chart_number_format_commas)n=new Intl.NumberFormat(window.gcfe_public_localize.locale_with_hyphen,{minimumFractionDigits:e.chart_datalabel_decimals_in_float??0,maximumFractionDigits:e.chart_datalabel_decimals_in_float??0}).format(n);else if(e.string_format){const c=e.chart_label_pointer_number_for_label??0;n=this.formatNumber(n,c)}return i+n+a}}applyTooltipFormatter(r,e,t){const i=e.chart_datalabel_prefix??"",a=e.chart_datalabel_postfix??"",n=e.chart_datalabel_decimals_in_float??0;r.tooltip||(r.tooltip={}),r.tooltip.y={formatter:function(c){let o=c;return e.chart_number_format_commas&&(o=new Intl.NumberFormat(window.gcfe_public_localize.locale_with_hyphen,{minimumFractionDigits:n,maximumFractionDigits:n}).format(c)),i+o+a}}}async updateChartType(r,e,t=!1){const i=r.data("element_id"),a=r.data("chart_options"),n=r.data("extra_data"),c=r.data("settings");if(!a||!i||!e){console.error("Missing required chart options or element ID.");return}if(e==="bar"&&a.chart.type!=="bar"&&(a.tooltip.shared=!1),a.chart.type=e,t){let d=[];const l=jQuery(`#graphina_chart_filter_${i}`).data("total_filter");for(let h=0;h<l;h++)d[h]=jQuery(`#graphina-start-date_${h}${i}`).val()??jQuery(`#graphina-drop_down_filter_${h}${i}`).val();const s=await this.getDynamicData(c,n,e,i,d);if(s.extra!==void 0){const h=s.extra.series||[],_=s.extra.category||[];h.length<=0&&(a.noData.text=n.no_data_text),a.series=h,["polar","radialBar","radial","pie","donut"].includes(e)?a.labels=_:a.xaxis.categories=_}else a.series=[],a.xaxis.categories=[]}e==="column"||e==="distributed_column"?a.chart.type="bar":a.chart.type=="polar"?a.chart.type="polarArea":a.chart.type=="radial"&&(a.chart.type="radialBar");const o=new ApexCharts(r[0],a);jQuery(r).show(),o.render().then(()=>console.log(`Chart updated to ${e}.`)).catch(d=>console.error("Error updating chart:",d)),jQuery(document).find(`.graphina-${i}-loader`).hide()}setFieldForForminator(r,e,t){const i=t.section_chart_forminator_aggregate,n=["mixed","brush","gantt_google"].includes(e)?r.forminator_columns:r.extra.forminator_columns;i?this.populateDropdownField(`[data-setting="${t.graphina_prefix}${e}_section_chart_forminator_aggregate_column"]`,n,t.section_chart_forminator_aggregate_column):(this.populateDropdownField(`[data-setting="${t.graphina_prefix}${e}_section_chart_forminator_x_axis_columns"]`,n,t.section_chart_forminator_x_axis_columns),this.populateDropdownField(`[data-setting="${t.graphina_prefix}${e}_section_chart_forminator_y_axis_columns"]`,n,t.section_chart_forminator_y_axis_columns))}setFieldsForCSV(r,e,t,i){const a=i.chart_dynamic_data_option==="sql-builder",n=a?e.extra.db_column:e.extra.column;this.populateDropdownField(`[data-setting="${i.graphina_prefix}${t}_${a?"chart_sql_builder_x_columns":"chart_csv_x_columns"}"]`,n,a?i.chart_csv_x_columns_sql:i.chart_csv_x_columns),this.populateDropdownField(`[data-setting="${i.graphina_prefix}${t}_${a?"chart_sql_builder_y_columns":"chart_csv_y_columns"}"]`,n,a?i.chart_csv_y_columns_sql:i.chart_csv_y_columns)}populateDropdownField(r,e,t){const i=parent.document.querySelector(r);if(i){i.innerHTML="";try{e.forEach(a=>{const n=Array.isArray(t)?t.includes(a):t===a;i.append(new Option(a,a,n,n))})}catch(a){console.log(a)}}}setFieldsForCounter(r,e,t,i){return!0}getDynamicData(r,e,t,i,a){let n="graphina_get_dynamic_data",c=gcfe_public_localize.nonce;t==="counter"&&(n="get_jquery_datatable_data",c=gcfe_public_localize.table_nonce);let o=jQuery(`[data-element_id="${i}"]`).closest("[data-elementor-id]").data("elementor-id");return new Promise((d,l)=>{jQuery.ajax({url:gcfe_public_localize.ajaxurl,type:"POST",dataType:"json",data:{action:n,nonce:c,chartType:t,post_id:o,element_id:i,series_count:e.chart_data_series_count_dynamic,settings:JSON.stringify(r),selected_field:a},success:s=>{s.status&&jQuery("body").hasClass("elementor-editor-active")&&(t==="counter"&&this.setFieldsForCounter(r,s,t,e),(e.chart_csv_column_wise_enable||e.chart_dynamic_data_option==="sql-builder")&&(e.chart_dynamic_data_option==="csv"||e.chart_dynamic_data_option==="remote-csv"||e.chart_dynamic_data_option==="google-sheet"||e.chart_dynamic_data_option==="sql-builder")&&this.setFieldsForCSV(r,s,t,e),e.dynamic_type==="forminator"&&this.setFieldForForminator(s,t,e)),d(s)},error:s=>{console.error("AJAX Error:",s),l(new Error("AJAX request failed."))}})})}getChartOptions(r,e,t,i){return r}afterRenderChart(r,e,t){return r}processDynamicData(r,e,t){return!0}afterManualLoad(r,e,t){return!0}afterDynamicLoad(r,e,t){return!0}async setupChart(r,e){try{const t=r.data("element_id"),i=r.data("chart_options"),a=r.data("responsive_options"),n=r.data("extra_data"),c=r.data("settings"),o=r.data("chart_type");if((o==="nested_column"||o==="brush"||o==="column")&&(e=o),!i||!t){console.error(`Missing required data attributes for ${e} chart.`);return}this.applyLegendTooltip(i,n,o),this.applyXAxisFormatter(i,n),this.applyDataLabelFormatter(i,n,o),this.applyTooltipFormatter(i,n,o),n.chart_opposite_yaxis_title_enable?(this.applyYAxisFormatter(i,n,0,o),this.applyYAxisFormatter(i,n,1,o)):this.applyYAxisFormatter(i,n,!1,o);const d=this.getChartOptions(i,e,n,t);this.mainChart[t]&&this.mainChart[t].destroy();const l=new ApexCharts(jQuery(r)[0],d);try{jQuery(document).find(`.graphina-${t}-loader`).hide(),await l.render()}catch(s){console.warn(s)}if(n.chart_data_option===!0){try{let s=[];const h=jQuery(`#graphina_chart_filter_${t}`).data("total_filter");for(let u=0;u<h;u++)s[u]=jQuery(`#graphina-start-date_${u}${t}`).val()??jQuery(`#graphina-drop_down_filter_${u}${t}`).val();const _=await this.getDynamicData(c,n,e,t,s);if(this.processDynamicData(_,t,n),_.extra!==void 0)if(o==="nested_column")l.updateSeries([{data:_.extra.series}],!0);else{const u={series:_.extra.series};["polar","radialBar","radial","pie","donut"].includes(o)?u.labels=_.extra.category:u.xaxis={...i.xaxis,categories:_.extra.category},l.updateOptions(u,!0),l.updateSeries(_.extra.series,!0),_.extra.series.length<=0&&(l.destroy(),jQuery(r).hide(),jQuery(`.graphina-${t}-notext`).show())}else _.extra.series.length<=0&&(l.destroy(),jQuery(r).hide(),jQuery(`.graphina-${t}-notext`).show()),l.updateOptions({series:[],categories:[]}),l.updateSeries([],!0);this.afterDynamicLoad(_,t,n)}catch(s){console.error("Failed to get dynamic data:",s)}jQuery(document).find(`.graphina-${t}-loader`).hide()}else this.afterManualLoad([],t,n);this.mainChart[t]=l,this.afterRenderChart(l,t,n),this.chartIntervals[t]&&clearInterval(this.chartIntervals[t]),n.can_chart_reload_ajax&&!jQuery("body").hasClass("elementor-editor-active")&&(this.chartIntervals[t]=setInterval(async()=>{try{const s=await this.getDynamicData(c,n,e,t),h=this.mainChart[t];if(!h||h.destroyed){clearInterval(this.chartIntervals[t]),delete this.chartIntervals[t];return}if(s!=null&&s.extra){const _={series:s.extra.series};["polar","radialBar","radial","pie","donut"].includes(o)?_.labels=s.extra.category||[]:_.xaxis={categories:s.extra.category||[]},h.updateOptions(_,!0)}}catch(s){console.warn(`Error in auto-refresh for chart ${t}:`,s)}},n.interval_data_refresh*1e3))}catch(t){console.error(`Error initializing ${e} chart:`,t)}}}export{p as G};
//# sourceMappingURL=GraphinaApexChartBase.js.map
