class p{constructor(){this.chartHandlers={},this.init(),this.mainChart={}}init(){this.setUpChartsHandler(),this.bindEventHandlers(),this.bindElementorInit()}bindEventHandlers(){jQuery(document.body).on("change",".graphina-select-apex-chart-type",this.debounce(this.handleChartTypeChange.bind(this),300)),jQuery(document.body).off("click",".graphina-filter-div-button.apex"),jQuery(document.body).on("click",".graphina-filter-div-button.apex",this.debounce(this.handleChartFilter.bind(this),300)),jQuery(document.body).off("click",".graphina-filter-div-button.common")}bindElementorInit(){let r=!1;const e=()=>{r||window.elementorFrontend&&window.elementorFrontend.elementsHandler&&(r=!0,window.elementorFrontend.hooks.addAction("frontend/element_ready/widget",t=>{const i=t.find(".graphina-elementor-chart");i.length>0&&this.initializeCharts(i)}))};window.elementorFrontend&&window.elementorFrontend.elementsHandler&&e(),jQuery(window).on("elementor/frontend/init",()=>{setTimeout(e,50)}),jQuery(document).ready(()=>{if(!r){const t=jQuery(".graphina-elementor-chart");t.length>0&&t.each((i,a)=>{this.initializeCharts(jQuery(a))})}})}debounce(r,e){let t;return function(...i){const a=this;clearTimeout(t),t=setTimeout(()=>r.apply(a,i),e)}}observeChartElement(r,e){const t=r.data("element_id");gcfe_public_localize.view_port==="off"?(this.observer[t]||(this.observer[t]=new IntersectionObserver(i=>{i.forEach(a=>{a.isIntersecting&&(this.setupChart(jQuery(a.target),e),this.observer[t].unobserve(a.target),this.observer[t].disconnect(),delete this.observer[t])})},{threshold:.1})),this.observer[t].observe(r[0])):this.setupChart(r,e)}handleChartTypeChange(r){const e=jQuery(r.target),t=e.val(),i=e.data("element_id"),a=jQuery(`.graphina-elementor-chart[data-element_id="${i}"]`);a.length>0&&(ApexCharts.exec(i,"destroy"),this.updateChartType(a,t))}handleChartFilter(r){const e=r.currentTarget,t=jQuery(e).data("element_id"),i=jQuery(`.graphina-elementor-chart[data-element_id="${t}"]`);let a=jQuery(i).data("chart_type");i.length>0&&(jQuery(`.graphina-${t}-notext`).hide(),ApexCharts.exec(t,"destroy"),jQuery(document).find(`.graphina-${t}-loader`).show(),this.updateChartType(i,a,!0))}setUpChartsHandler(){throw new Error("setUpChartsHandler method must be implemented by subclasses")}initializeCharts(r){const e=r.data("chart_type");this.chartHandlers[e]&&this.chartHandlers[e](r)}formatNumber(r,e){const t=["","K","M","B","T"];let i=0;for(;r>=1e3&&i<t.length-1;)r/=1e3,i++;return new Intl.NumberFormat(window.gcfe_public_localize.locale_with_hyphen,{minimumFractionDigits:e,maximumFractionDigits:e}).format(r)+t[i]}applyLegendTooltip(r,e,t){e.legend_show_series_value&&(r.legend.tooltipHoverFormatter=(i,a)=>{let o=a.w.globals.series[a.seriesIndex][a.dataPointIndex];return i=decodeURIComponent(i),["polar","scatter","pie","donut","radial"].includes(t)&&(o=a.w.globals.series[a.seriesIndex]),`<div class="legend-info"><span>${i}</span>:<strong>${o}</strong></div>`})}applyXAxisFormatter(r,e){e.xaxis_label_prefix_show&&(r.xaxis.labels.formatter=t=>`${e.xaxis_label_prefix}${t}${e.xaxis_label_postfix}`)}applyYAxisFormatter(r,e,t=!1,i){const a=(c,n,_,s)=>e.chart_yaxis_label_pointer?n+this.formatNumber(c,s)+_:typeof s=="number"&&s>0?n+new Intl.NumberFormat(window.gcfe_public_localize.locale_with_hyphen,{minimumFractionDigits:s,maximumFractionDigits:s}).format(c)+_:n+c+_,o=(c,n,_,s)=>{c.labels||(c.labels={}),c.labels.formatter=l=>a(l,n,_,s)};if(t===!1){const c=e.yaxis_label_prefix||"",n=e.yaxis_label_postfix||"";let _=0;e.chart_yaxis_label_pointer?_=typeof e.chart_yaxis_label_pointer_number=="number"?e.chart_yaxis_label_pointer_number:0:_=typeof e.decimal_in_float=="number"?e.decimal_in_float:0,o(r.yaxis,c,n,_)}else if(t===0||t===1){const c=r.yaxis[t],n=t===0?e.yaxis_label_prefix||"":e.chart_opposite_yaxis_label_prefix||"",_=t===0?e.yaxis_label_postfix||"":e.chart_opposite_yaxis_label_postfix||"";let s=0;(t===0||t===1&&e.chart_opposite_yaxis_format_number===!0)&&(e.chart_yaxis_label_pointer?s=typeof e.chart_yaxis_label_pointer_number=="number"?e.chart_yaxis_label_pointer_number:0:s=typeof e.decimal_in_float=="number"?e.decimal_in_float:0),o(c,n,_,s)}}applyDataLabelFormatter(r,e,t){let i=e.chart_datalabel_prefix??"",a=e.chart_datalabel_postfix??"";r.dataLabels||(r.dataLabels={}),r.dataLabels.formatter=o=>{if(e.chart_number_format_commas)o=new Intl.NumberFormat(window.gcfe_public_localize.locale_with_hyphen,{minimumFractionDigits:e.chart_datalabel_decimals_in_float??0,maximumFractionDigits:e.chart_datalabel_decimals_in_float??0}).format(o);else if(e.string_format){const c=e.chart_label_pointer_number_for_label??0;o=this.formatNumber(o,c)}return i+o+a}}applyTooltipFormatter(r,e,t){const i=e.chart_datalabel_prefix??"",a=e.chart_datalabel_postfix??"",o=e.chart_datalabel_decimals_in_float??0;r.tooltip||(r.tooltip={}),r.tooltip.y={formatter:function(c){let n=c;return e.chart_number_format_commas&&(n=new Intl.NumberFormat(window.gcfe_public_localize.locale_with_hyphen,{minimumFractionDigits:o,maximumFractionDigits:o}).format(c)),i+n+a}}}async updateChartType(r,e,t=!1){const i=r.data("element_id"),a=r.data("chart_options"),o=r.data("extra_data"),c=r.data("settings");if(!a||!i||!e){console.error("Missing required chart options or element ID.");return}if(e==="bar"&&a.chart.type!=="bar"&&(a.tooltip.shared=!1),a.chart.type=e,t){let _=[];const s=jQuery(`#graphina_chart_filter_${i}`).data("total_filter");for(let h=0;h<s;h++)_[h]=jQuery(`#graphina-start-date_${h}${i}`).val()??jQuery(`#graphina-drop_down_filter_${h}${i}`).val();const l=await this.getDynamicData(c,o,e,i,_);if(l.extra!==void 0){const h=l.extra.series||[],d=l.extra.category||[];h.length<=0&&(a.noData.text=o.no_data_text),a.series=h,["polar","radialBar","radial","pie","donut"].includes(e)?a.labels=d:a.xaxis.categories=d}else a.series=[],a.xaxis.categories=[]}e==="column"||e==="distributed_column"?a.chart.type="bar":a.chart.type=="polar"?a.chart.type="polarArea":a.chart.type=="radial"&&(a.chart.type="radialBar");const n=new ApexCharts(r[0],a);jQuery(r).show(),n.render().then(()=>console.log(`Chart updated to ${e}.`+JSON.stringify(a))).catch(_=>console.error("Error updating chart:",_)),jQuery(document).find(`.graphina-${i}-loader`).hide()}setFieldForForminator(r,e,t){const i=t.section_chart_forminator_aggregate,o=["mixed","brush","gantt_google"].includes(e)?r.forminator_columns:r.extra.forminator_columns;i?this.populateDropdownField(`[data-setting="${t.graphina_prefix}${e}_section_chart_forminator_aggregate_column"]`,o,t.section_chart_forminator_aggregate_column):(this.populateDropdownField(`[data-setting="${t.graphina_prefix}${e}_section_chart_forminator_x_axis_columns"]`,o,t.section_chart_forminator_x_axis_columns),this.populateDropdownField(`[data-setting="${t.graphina_prefix}${e}_section_chart_forminator_y_axis_columns"]`,o,t.section_chart_forminator_y_axis_columns))}setFieldsForCSV(r,e,t,i){const a=i.chart_dynamic_data_option==="sql-builder",o=a?e.extra.db_column:e.extra.column;this.populateDropdownField(`[data-setting="${i.graphina_prefix}${t}_${a?"chart_sql_builder_x_columns":"chart_csv_x_columns"}"]`,o,a?i.chart_csv_x_columns_sql:i.chart_csv_x_columns),this.populateDropdownField(`[data-setting="${i.graphina_prefix}${t}_${a?"chart_sql_builder_y_columns":"chart_csv_y_columns"}"]`,o,a?i.chart_csv_y_columns_sql:i.chart_csv_y_columns)}populateDropdownField(r,e,t){const i=parent.document.querySelector(r);if(i){i.innerHTML="";try{e.forEach(a=>{const o=Array.isArray(t)?t.includes(a):t===a;i.append(new Option(a,a,o,o))})}catch(a){console.log(a)}}}setFieldsForCounter(r,e,t,i){return!0}getDynamicData(r,e,t,i,a){let o="graphina_get_dynamic_data",c=gcfe_public_localize.nonce;t==="counter"&&(o="get_jquery_datatable_data",c=gcfe_public_localize.table_nonce);let n=jQuery(`[data-element_id="${i}"]`).closest("[data-elementor-id]").data("elementor-id");return new Promise((_,s)=>{jQuery.ajax({url:gcfe_public_localize.ajaxurl,type:"POST",dataType:"json",data:{action:o,nonce:c,chartType:t,post_id:n,element_id:i,series_count:e.chart_data_series_count_dynamic,settings:JSON.stringify(r),selected_field:a},success:l=>{l.status&&jQuery("body").hasClass("elementor-editor-active")&&(t==="counter"&&this.setFieldsForCounter(r,l,t,e),(e.chart_csv_column_wise_enable||e.chart_dynamic_data_option==="sql-builder")&&(e.chart_dynamic_data_option==="csv"||e.chart_dynamic_data_option==="remote-csv"||e.chart_dynamic_data_option==="google-sheet"||e.chart_dynamic_data_option==="sql-builder")&&this.setFieldsForCSV(r,l,t,e),e.dynamic_type==="forminator"&&this.setFieldForForminator(l,t,e)),_(l)},error:l=>{console.error("AJAX Error:",l),s(new Error("AJAX request failed."))}})})}getChartOptions(r,e,t,i,a){return r}afterRenderChart(r,e,t){return r}processDynamicData(r,e,t){return!0}afterManualLoad(r,e,t){return!0}afterDynamicLoad(r,e,t){return!0}async setupChart(r,e){try{const t=r.data("element_id"),i=r.data("chart_options"),a=r.data("responsive_options"),o=r.data("extra_data"),c=r.data("settings"),n=r.data("chart_type");if((n==="nested_column"||n==="brush"||n==="column")&&(e=n),!i||!t){console.error(`Missing required data attributes for ${e} chart.`);return}this.applyLegendTooltip(i,o,n),this.applyXAxisFormatter(i,o),this.applyDataLabelFormatter(i,o,n),this.applyTooltipFormatter(i,o,n),this.applyTooltipFormatter(i,o),o.chart_opposite_yaxis_title_enable?(this.applyYAxisFormatter(i,o,0,n),this.applyYAxisFormatter(i,o,1,n)):this.applyYAxisFormatter(i,o,!1,n);const _=this.getChartOptions(i,e,o,a,t);this.mainChart[t]&&this.mainChart[t].destroy();const s=new ApexCharts(jQuery(r)[0],_);try{jQuery(document).find(`.graphina-${t}-loader`).hide(),await s.render()}catch(l){console.warn(l)}if(o.chart_data_option===!0){try{let l=[];const h=jQuery(`#graphina_chart_filter_${t}`).data("total_filter");for(let u=0;u<h;u++)l[u]=jQuery(`#graphina-start-date_${u}${t}`).val()??jQuery(`#graphina-drop_down_filter_${u}${t}`).val();const d=await this.getDynamicData(c,o,e,t,l);if(this.processDynamicData(d,t,o),d.extra!==void 0)if(n==="nested_column")s.updateSeries([{data:d.extra.series}],!0);else{const u={series:d.extra.series};["polar","radialBar","radial","pie","donut"].includes(n)?u.labels=d.extra.category:u.xaxis={...i.xaxis,categories:d.extra.category},s.updateOptions(u,!0),s.updateSeries(d.extra.series,!0),d.extra.series.length<=0&&(s.destroy(),jQuery(r).hide(),jQuery(`.graphina-${t}-notext`).show())}else d.extra.series.length<=0&&(s.destroy(),jQuery(r).hide(),jQuery(`.graphina-${t}-notext`).show()),s.updateOptions({series:[],categories:[]}),s.updateSeries([],!0);this.afterDynamicLoad(d,t,o)}catch(l){console.error("Failed to get dynamic data:",l)}jQuery(document).find(`.graphina-${t}-loader`).hide()}else this.afterManualLoad([],t,o);this.mainChart[t]=s,this.afterRenderChart(s,t,o),o.can_chart_reload_ajax&&!jQuery("body").hasClass("elementor-editor-active")&&setInterval(async()=>{try{const l=await this.getDynamicData(c,o,e,t);l!=null&&l.extra?(s.updateSeries(l.extra.series),s.updateOptions(l.chart_option)):console.warn(`No data returned for ${e} chart with ID ${t}.`)}catch{console.warn(`Error fetching dynamic data for ${e} chart with ID ${t}:`)}},o.interval_data_refresh*1e3)}catch(t){console.error(`Error initializing ${e} chart:`,t)}}}export{p as G};
//# sourceMappingURL=GraphinaApexChartBase.js.map
